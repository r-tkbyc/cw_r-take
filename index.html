<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>%PRODUCT_NAME% | WebAR</title>
  <!-- テンプレート内のCSS/画像は TemplateData/ 配下に -->
  <link rel="preload" as="image" href="TemplateData/logo.png" />
  <link rel="stylesheet" href="TemplateData/style.css" />
  <!-- Unity ローダはビルド時に実体パスへ置換されます -->
  <script defer src="%UNITY_WEBGL_LOADER_URL%"></script>
</head>
<body>
  <!-- ① 事前許諾ゲート（ブラウザの許可UIの“前置き”） -->
  <div id="gate" class="overlay">
    <div class="card">
      <img src="TemplateData/logo.png" alt="Brand" class="logo" />
      <h1>カメラを使用します</h1>
      <p>「はじめる」を押すと、カメラへのアクセス許可が求められます。</p>
      <button id="startBtn" class="btn-primary">はじめる</button>
      <p class="note">※お使いの機種・ブラウザによっては動作しない場合があります。</p>
    </div>
  </div>
  <!-- ② ローディングUI（Unity起動〜読込の見せ方をカスタム） -->
  <div id="loader" class="overlay" style="display:none">
    <div class="card">
      <img src="TemplateData/logo.png" alt="Brand" class="logo" />
      <div class="bar"><div id="barFill" class="fill" style="width:0%"></div></div>
      <div id="status">コンテンツ読み込み中… 0%</div>
    </div>
  </div>
  <!-- ③ Unity WebGL マウント先 -->
  <div id="unity-container" style="width:100vw;height:100vh"></div>
  <script>
    const gate     = document.getElementById('gate');
    const loader   = document.getElementById('loader');
    const startBtn = document.getElementById('startBtn');
    const barFill  = document.getElementById('barFill');
    const statusEl = document.getElementById('status');
    async function requestCameraOnce() {
      // 事前に許諾だけを取得（直後に停止）。UIはテンプレ側でブランディング。
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      stream.getTracks().forEach(t => t.stop());
    }
    function startUnity() {
      loader.style.display = 'block';
      const container = document.getElementById('unity-container');
      // createUnityInstance はローダJSから提供。進捗コールバックでUI更新。
      createUnityInstance(container, {
        dataUrl: "%UNITY_WEBGL_BUILD_URL%/%UNITY_WEBGL_BUILD_NAME%.data.unityweb",
        frameworkUrl: "%UNITY_WEBGL_BUILD_URL%/%UNITY_WEBGL_BUILD_NAME%.framework.js.unityweb",
        codeUrl: "%UNITY_WEBGL_BUILD_URL%/%UNITY_WEBGL_BUILD_NAME%.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "%COMPANY_NAME%",
        productName: "%PRODUCT_NAME%",
        productVersion: "%PRODUCT_VERSION%"
      }, (progress) => {
        const p = Math.round(progress * 100);
        barFill.style.width = p + "%";
        statusEl.textContent = `コンテンツ読み込み中… ${p}%`;
      }).then((unityInstance) => {
        // 読み込み完了でローディングUIを外す
        loader.style.display = 'none';
        // もしImagine WebARの初期化完了イベントが必要なら、
        // SendMessage でフック→こちら側でHUD制御も可能。
      }).catch((msg) => {
        statusEl.textContent = "読み込みに失敗しました: " + msg;
      });
    }
    startBtn.addEventListener('click', async () => {
      try {
        gate.style.display = 'none';
        await requestCameraOnce(); // ここでブラウザの許可ダイアログを出して通す
      } catch (e) {
        // 拒否されたらゲートを戻してリトライさせる
        gate.style.display = 'block';
        return;
      }
      startUnity();
    });
  </script>
</body>
</html>
